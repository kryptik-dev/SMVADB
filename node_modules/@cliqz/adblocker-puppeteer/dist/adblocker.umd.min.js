!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("tldts-experimental"),require("@cliqz/adblocker"),require("@cliqz/adblocker-content")):"function"==typeof define&&define.amd?define(["exports","tldts-experimental","@cliqz/adblocker","@cliqz/adblocker-content"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).adblocker={},e.tldtsExperimental,e.adblocker,e.adblockerContent)}(this,(function(e,t,o,s){"use strict";function n(e){return new Promise((t=>{setTimeout(t,e)}))}function i(e){let t="";for(;null!==e&&(t=e.url(),0===t.length);)e=e.parentFrame();return t}function r(e){const t=i(e.frame()),s=e.url(),n=e.resourceType();return o.Request.fromRawDetails({_originalRequestDetails:e,requestId:`${n}-${s}-${t}`,sourceUrl:t,type:n,url:s})}class a{constructor(e,t){this.page=e,this.blocker=t,this.onFrameNavigated=e=>t.onFrameNavigated(e),this.onDomContentLoaded=()=>t.onFrameNavigated(this.page.mainFrame()),this.onRequest=e=>t.onRequest(e)}async enable(){this.blocker.config.loadCosmeticFilters&&(this.page.on("frameattached",this.onFrameNavigated),this.page.on("domcontentloaded",this.onDomContentLoaded)),this.blocker.config.loadNetworkFilters&&(await this.page.setRequestInterception(!0),this.page.on("request",this.onRequest))}async disable(){this.blocker.config.loadNetworkFilters&&(this.page.off("request",this.onRequest),await this.page.setRequestInterception(!1)),this.blocker.config.loadCosmeticFilters&&(this.page.off("frameattached",this.onFrameNavigated),this.page.off("domcontentloaded",this.onDomContentLoaded))}}class c extends o.FiltersEngine{constructor(){super(...arguments),this.contexts=new WeakMap,this.priority=void 0,this.onFrameNavigated=async e=>{try{await this.onFrame(e)}catch(e){}},this.onFrame=async e=>{const o=e.url();if("chrome-error://chromewebdata/"===o)return;this.removeBlockedFrames(e).catch((()=>{}));const i=t.parse(o),r=i.hostname||"",a=i.domain||"";{const{active:t,styles:s,scripts:n}=this.getCosmeticsFilters({domain:a,hostname:r,url:o,getBaseRules:!0,getInjectionRules:!0,getExtendedRules:!0,getRulesFromHostname:!0,getRulesFromDOM:!1});if(!1===t)return;Promise.all([this.injectScriptletsIntoFrame(e,n),this.injectStylesIntoFrame(e,s)]).catch((()=>{}))}const c=new s.DOMMonitor((t=>{if("features"===t.type){const{active:s,styles:n}=this.getCosmeticsFilters({domain:a,hostname:r,url:o,...t,getBaseRules:!1,getInjectionRules:!1,getExtendedRules:!1,getRulesFromHostname:!1,getRulesFromDOM:!0});if(!1===s)return;this.injectStylesIntoFrame(e,n).catch((()=>{}))}}));let l=0;for(;;){if(e.isDetached())break;try{const t=c.handleNewFeatures(await e.$$eval(":root",s.extractFeaturesFromDOM));if(l+=1,10===l)break;if(!1===t)break}catch(e){break}if(!1===this.config.enableMutationObserver)break;await n(500)}},this.setRequestInterceptionPriority=(e=0)=>this.priority=e,this.onRequest=e=>{var t,o,s;if(null===(t=e.isInterceptResolutionHandled)||void 0===t?void 0:t.call(e))return;const n=r(e);!0===this.config.guessRequestTypeFromUrl&&"other"===n.type&&n.guessTypeOfRequest();const i=e.frame();if(n.isMainFrame()||"document"===n.type&&null!==i&&null===i.parentFrame())return void e.continue(null===(o=e.continueRequestOverrides)||void 0===o?void 0:o.call(e),0);const{redirect:a,match:c}=this.match(n);void 0!==a?a.contentType.endsWith(";base64")?e.respond({status:200,headers:{},body:Buffer.from(a.body,"base64"),contentType:a.contentType.slice(0,-7)},this.priority):e.respond({status:200,headers:{},body:a.body,contentType:a.contentType},this.priority):!0===c?e.abort("blockedbyclient",this.priority):e.continue(null===(s=e.continueRequestOverrides)||void 0===s?void 0:s.call(e),0)}}async enableBlockingInPage(e){let t=this.contexts.get(e);return void 0!==t||(t=new a(e,this),this.contexts.set(e,t),await t.enable()),t}async disableBlockingInPage(e){const t=this.contexts.get(e);if(void 0===t)throw new Error("Trying to disable blocking which was not enabled");this.contexts.delete(e),await t.disable()}isBlockingEnabled(e){return this.contexts.has(e)}async injectStylesIntoFrame(e,t){0!==t.length&&await e.addStyleTag({content:t})}async injectScriptletsIntoFrame(e,t){const o=[];if(0!==t.length)for(let n=0;n<t.length;n+=1)o.push(e.addScriptTag({content:s.autoRemoveScript(t[n])}).then((()=>{})));await Promise.all(o)}async removeBlockedFrames(e){const t=[],s=i(e);for(const n of await e.$$eval("iframe[src],iframe[href]",(e=>e.map((({src:e,href:t})=>e||t))))){const{match:i}=this.match(o.Request.fromRawDetails({url:n,sourceUrl:s,type:"sub_frame"}));i&&t.push(e.$$eval(`iframe[src="${n}"],iframe[href="${n}"]`,(e=>{var t;for(const o of e)null===(t=null==o?void 0:o.parentNode)||void 0===t||t.removeChild(o)})).catch((()=>{})))}await Promise.all(t)}}e.BlockingContext=a,e.PuppeteerBlocker=c,e.fromPuppeteerDetails=r,Object.keys(o).forEach((function(t){"default"===t||Object.prototype.hasOwnProperty.call(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:function(){return o[t]}})}))}));
//# sourceMappingURL=adblocker.umd.min.js.map
